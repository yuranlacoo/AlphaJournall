<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AlphaJournall | CalendÃ¡rio</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">

  <style>
    body {
      background-color: #0f0f10;
      color: #fff;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      text-align: center;
      padding: 20px;
      border-bottom: 1px solid #333;
    }

    header button {
      background-color: #00bcd4;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 8px 16px;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 10px;
    }

    header button:hover {
      background-color: #0097a7;
    }

    .stats {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      width: 90%;
      margin: 20px 0;
    }

    .stat-box {
      background: #1a1a1d;
      padding: 15px 25px;
      border-radius: 10px;
      text-align: center;
      margin: 10px;
      min-width: 150px;
    }

    .month-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 10px 0;
    }

    .month-nav button {
      background: #00bcd4;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 5px 12px;
      cursor: pointer;
      transition: 0.3s;
    }

    .month-nav button:hover {
      background: #0097a7;
    }

    .calendar {
      width: 90%;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .day {
      background: #1a1a1d;
      border-radius: 10px;
      padding: 8px;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-size: 14px;
      position: relative;
      transition: 0.2s;
    }

    .day:hover {
      background: #222;
    }

    .day-number {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .green { background: #0b6e4f; }
    .red { background: #a11d33; }
    .gray { background: #444; }

    .trade-info {
      font-size: 12px;
      text-align: center;
    }
  </style>
</head>
<body>

  <header>
    <h1>CalendÃ¡rio de Trades</h1>
    <button onclick="window.location.href='dashboard.html'">â¬… Voltar ao Dashboard</button>
  </header>

  <div class="stats">
    <div class="stat-box"><strong>Total Trades</strong><br><span id="totalTrades">0</span></div>
    <div class="stat-box"><strong>P&L</strong><br><span id="totalPL">$0.00</span></div>
    <div class="stat-box"><strong>Best Day</strong><br><span id="bestDay">$0.00</span></div>
    <div class="stat-box"><strong>Worst Day</strong><br><span id="worstDay">$0.00</span></div>
    <div class="stat-box"><strong>Win Rate</strong><br><span id="winRate">0%</span></div>
  </div>

  <div class="month-nav">
    <button onclick="changeMonth(-1)">â¬…</button>
    <h2 id="monthYear"></h2>
    <button onclick="changeMonth(1)">âž¡</button>
  </div>

  <div id="calendar" class="calendar"></div>

  <script>
    let currentDate = new Date();

   function getTrades() {
  // LÃª a mesma key que o dashboard usa
  const raw = localStorage.getItem('alpha_journal_v2');
  if (!raw) return [];
  try {
    return JSON.parse(raw);
  } catch (e) {
    console.error('Erro a parsear alpha_journal_v2:', e);
    return [];
  }
}

    function renderCalendar() {
      const trades = getTrades();
      const calendar = document.getElementById("calendar");
      const monthYear = document.getElementById("monthYear");

      const month = currentDate.getMonth();
      const year = currentDate.getFullYear();
      monthYear.textContent = currentDate.toLocaleString("pt-BR", { month: "long", year: "numeric" });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      calendar.innerHTML = "";

      // Dias vazios antes do inÃ­cio do mÃªs
      for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
        const emptyDiv = document.createElement("div");
        calendar.appendChild(emptyDiv);
      }

      let totalPL = 0, winCount = 0, lossCount = 0, breakevenCount = 0;

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        // ðŸ”¥ CORREÃ‡ÃƒO AQUI ðŸ”¥
        const dayTrades = trades.filter(t => {
          const normalized = new Date(t.date).toISOString().slice(0, 10);
          return normalized === dateStr;
        });

        const div = document.createElement("div");
        div.className = "day";

        const dayNumber = document.createElement("div");
        dayNumber.className = "day-number";
        dayNumber.textContent = day;
        div.appendChild(dayNumber);

        if (dayTrades.length > 0) {
          let dayPL = 0;
          dayTrades.forEach(t => {
            dayPL += parseFloat(t.result || 0);
          });

          const info = document.createElement("div");
          info.className = "trade-info";
          info.innerHTML = `${dayTrades.length} Trades<br>${dayPL.toFixed(2)}`;
          div.appendChild(info);

          totalPL += dayPL;

          if (dayPL > 0) { div.classList.add("green"); winCount++; }
          else if (dayPL < 0) { div.classList.add("red"); lossCount++; }
          else { div.classList.add("gray"); breakevenCount++; }
        }

        calendar.appendChild(div);
      }

      // EstatÃ­sticas gerais
      const totalTrades = trades.length;
      document.getElementById("totalTrades").textContent = totalTrades;
      document.getElementById("totalPL").textContent = `$${totalPL.toFixed(2)}`;
      document.getElementById("winRate").textContent = totalTrades > 0 ? `${((winCount / totalTrades) * 100).toFixed(2)}%` : "0%";
      document.getElementById("bestDay").textContent = `$${Math.max(...trades.map(t => parseFloat(t.result || 0)), 0).toFixed(2)}`;
      document.getElementById("worstDay").textContent = `$${Math.min(...trades.map(t => parseFloat(t.result || 0)), 0).toFixed(2)}`;
    }

    function changeMonth(offset) {
      currentDate.setMonth(currentDate.getMonth() + offset);
      renderCalendar();
    }

// Atualiza quando a chave usada pelo dashboard muda
window.addEventListener("storage", (event) => {
  if (event.key === "alpha_journal_v2") {
    renderCalendar();
  }
});


    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        renderCalendar();
      }
    });

    document.addEventListener("DOMContentLoaded", renderCalendar);
  </script>

</body>
</html>
