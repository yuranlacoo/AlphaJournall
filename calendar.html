<script>
  const trades = JSON.parse(localStorage.getItem("trades") || "[]");
  let currentDate = new Date();

  function getTrades() {
    return JSON.parse(localStorage.getItem("trades") || "[]");
  }

  function renderCalendar() {
    const calendar = document.getElementById("calendar");
    const monthYear = document.getElementById("monthYear");

    const trades = getTrades();
    const month = currentDate.getMonth();
    const year = currentDate.getFullYear();
    monthYear.textContent = currentDate.toLocaleString("pt-BR", { month: "long", year: "numeric" });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    calendar.innerHTML = "";

    // Adicionar dias vazios antes do início do mês
    for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
      const emptyDiv = document.createElement("div");
      calendar.appendChild(emptyDiv);
    }

    let totalPL = 0, winCount = 0, lossCount = 0, breakevenCount = 0;

    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
      const dayTrades = trades.filter(t => t.date === dateStr);

      const div = document.createElement("div");
      div.className = "day";

      const dayNumber = document.createElement("div");
      dayNumber.className = "day-number";
      dayNumber.textContent = day;
      div.appendChild(dayNumber);

      if (dayTrades.length > 0) {
        let dayPL = 0;
        dayTrades.forEach(t => {
          dayPL += parseFloat(t.result || 0);
        });

        const info = document.createElement("div");
        info.className = "trade-info";
        info.innerHTML = `${dayTrades.length} Trades<br>$${dayPL.toFixed(2)}`;
        div.appendChild(info);

        totalPL += dayPL;

        if (dayPL > 0) { div.classList.add("green"); winCount++; }
        else if (dayPL < 0) { div.classList.add("red"); lossCount++; }
        else { div.classList.add("gray"); breakevenCount++; }
      }

      calendar.appendChild(div);
    }

    // Estatísticas gerais
    const totalTrades = trades.length;
    document.getElementById("totalTrades").textContent = totalTrades;
    document.getElementById("totalPL").textContent = `$${totalPL.toFixed(2)}`;
    document.getElementById("winRate").textContent = totalTrades > 0 ? `${((winCount / totalTrades) * 100).toFixed(2)}%` : "0%";
    document.getElementById("bestDay").textContent = `$${Math.max(...trades.map(t => parseFloat(t.result || 0)), 0).toFixed(2)}`;
    document.getElementById("worstDay").textContent = `$${Math.min(...trades.map(t => parseFloat(t.result || 0)), 0).toFixed(2)}`;
  }

  function changeMonth(offset) {
    currentDate.setMonth(currentDate.getMonth() + offset);
    renderCalendar();
  }

  // Atualiza automaticamente se o localStorage mudar
  window.addEventListener("storage", (event) => {
    if (event.key === "trades") {
      renderCalendar();
    }
  });

  document.addEventListener("DOMContentLoaded", renderCalendar);
</script>
