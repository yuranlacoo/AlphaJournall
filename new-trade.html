<!doctype html>
<html lang="pt-BR">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>AlphaJournal - Novo Trade</title>
<link rel="stylesheet" href="assets/css/style.css"></head><body>
<div class="container">
  <div class="header"><div class="brand"><div class="logo">A▲</div><h1>AlphaJournal</h1></div></div>
  <main style="margin-top:18px">
    <div style="max-width:820px;margin:0 auto;background:var(--panel);padding:18px;border-radius:12px">
      <a href="dashboard.html" class="btn small">← Voltar</a>
      <h2 class="small">Registrar Trade</h2>
      <div class="form-grid">
        <input id="ativo" class="input" placeholder="Ativo (ex: PETR4)">
        <input id="data" type="date" class="input">
        <select id="mercado" class="input"><option>Ações</option><option>Futuros</option><option>Forex</option><option>Cripto</option></select>
        <select id="tipo" class="input"><option>Compra</option><option>Venda</option></select>
      </div>
      <div style="height:8px"></div>
      <div class="form-grid">
        <input id="entrada" class="input" placeholder="Preço de Entrada (R$)" type="number" step="0.01">
        <input id="saida" class="input" placeholder="Preço de Saída (R$)" type="number" step="0.01">
      </div>
      <div style="height:8px"></div>
      <div class="form-grid">
        <input id="quantidade" class="input" placeholder="Quantidade" type="number">
        <input id="precoEntrada" class="input" placeholder="Preço por lote (opcional)" type="number" step="0.01">
      </div>
      <div style="height:8px"></div>
      <input id="setup" class="input" placeholder="Setup utilizado (ex: Pullback)">
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="small">Print da operação</label>
        <input id="print" type="file" accept="image/*">
      </div>
      <div style="height:10px"></div>
      <textarea id="obs" class="input" rows="4" placeholder="Observações (opcional)"></textarea>
      <div style="height:12px"></div>
      <div style="display:flex;gap:8px">
        <button id="btnSave" class="btn">Salvar Trade</button>
        <button id="btnSaveLocal" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);">Salvar Local</button>
      </div>
      <div id="msg" class="small" style="margin-top:8px"></div>
    </div>
  </main>
</div>
<script type="module">
import { queueTrade, syncAll } from './assets/js/app-sync.js';
import { onAuth } from './assets/js/auth.js';

function readImageAsDataURL(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}

async function collectAndQueue(){
  const trade = {
    id: 't_'+Date.now(),
    ativo: document.getElementById('ativo').value,
    data: document.getElementById('data').value || new Date().toISOString().slice(0,10),
    mercado: document.getElementById('mercado').value,
    tipo: document.getElementById('tipo').value,
    entrada: document.getElementById('entrada').value,
    saida: document.getElementById('saida').value,
    quantidade: document.getElementById('quantidade').value,
    precoEntrada: document.getElementById('precoEntrada').value,
    setup: document.getElementById('setup').value,
    obs: document.getElementById('obs').value,
    imagem: null,
    synced:false
  };
  const f = document.getElementById('print').files[0];
  if(f){ trade.imagem = await readImageAsDataURL(f); }
  queueTrade(trade);
  document.getElementById('msg').textContent = 'Trade salvo localmente. ⏱ Será sincronizado quando houver conexão e login.';
}

document.getElementById('btnSave').addEventListener('click', async ()=>{
  await collectAndQueue();
  onAuth(async (u)=>{ if(u){ await syncAll(u.uid); window.location.href='dashboard.html'; } else { window.location.href='dashboard.html'; } });
});

document.getElementById('btnSaveLocal').addEventListener('click', async ()=>{ await collectAndQueue(); });
</script>
</body></html>