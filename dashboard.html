<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AlphaJournal - Dashboard</title>
<link rel="stylesheet" href="style.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
</head>

<body>

<header class="dashboard-header">
    <h2>ðŸ“ˆ Dashboard</h2>
    <button id="logoutBtn" class="logout-btn">Sair</button>
</header>

<section class="kpi-container">
    <div class="kpi-card">
        <h4>BalanÃ§o Total</h4>
        <p id="totalBalance">$ 0,00</p>
    </div>
    <div class="kpi-card">
        <h4>Trades</h4>
        <p id="totalTrades">0</p>
    </div>
    <div class="kpi-card">
        <h4>Win Rate</h4>
        <p id="winRate">0%</p>
    </div>
</section>

<section class="chart-section">
    <h3>Equity Curve</h3>
    <canvas id="equityChart" height="120"></canvas>
</section>

<section style="text-align:center; margin-top: 20px;">
    <a href="register-trade.html" class="add-btn">Registrar Trade</a>
</section>

<script>
// âœ… Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBGeQ1-IKrCyC8hA2BETaJLidLpuYrCRmk",
  authDomain: "alphajournal-dc6bb.firebaseapp.com",
  projectId: "alphajournal-dc6bb",
  storageBucket: "alphajournal-dc6bb.firebasestorage.app",
  messagingSenderId: "835722822229",
  appId: "1:835722822229:web:974ee6dc7b6696f1edcadc"
};

// âœ… Inicializar Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// âœ… Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
    auth.signOut().then(() => location.href = "index.html");
});

// âœ… Carregar dados apÃ³s login
auth.onAuthStateChanged(async (user) => {
    if (!user) return location.href = "index.html";

    console.log("UsuÃ¡rio logado âœ…", user.uid);

    const tradesSnap = await db.collection("users")
        .doc(user.uid)
        .collection("trades")
        .orderBy("date", "asc")
        .get();

    let balance = 0;
    let wins = 0;
    let trades = 0;
    const labels = [];
    const equity = [];

    tradesSnap.forEach(doc => {
        const t = doc.data();
        trades++;

        const result = parseFloat(t.result || 0);
        if (result > 0) wins++;

        balance += result;

        labels.push(new Date(t.date).toLocaleDateString("pt-BR"));
        equity.push(balance);
    });

    document.getElementById("totalTrades").textContent = trades;
    document.getElementById("totalBalance").textContent = 
        "R$ " + balance.toFixed(2);
    document.getElementById("winRate").textContent =
        trades > 0 ? ((wins / trades) * 100).toFixed(0) + "%" : "0%";

    if (trades === 0) return;

    const ctx = document.getElementById("equityChart").getContext("2d");
    new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                data: equity,
                borderWidth: 3,
                borderColor: "#00E8FF",
                backgroundColor: "rgba(0,232,255,0.10)",
                fill: true,
                pointRadius: 0,
                tension: 0.4
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: "#fff" } },
                y: { ticks: { color: "#fff" } }
            }
        }
    });
});
</script>

</body>
</html>

