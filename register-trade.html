<!doctype html>
<html lang="pt-BR">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Registrar Trade</title><link rel="stylesheet" href="style.css"></head>
<body>
  <div class="auth-wrap">
    <div class="auth-card" style="max-width:820px">
      <h2>Registrar Trade</h2>

      <div class="form-grid">
        <input id="ativo" placeholder="Ativo (ex: PETR4)" />
        <select id="tipo"><option>Compra</option><option>Venda</option></select>
        <input id="data" type="date" />
        <input id="resultado" type="number" step="0.01" placeholder="Resultado (R$)"/>
        <input id="quantidade" type="number" placeholder="Quantidade / lotes"/>
        <input id="setup" placeholder="Setup (ex: Pullback)"/>
        <textarea id="obs" rows="4" placeholder="Observações (opcional)"></textarea>
        <div>
          <label class="muted">Print da operação</label>
          <input id="print" type="file" accept="image/*">
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px">
        <button id="btnSave" class="btn primary">Salvar e Sincronizar</button>
        <button id="btnSaveLocal" class="btn ghost">Salvar Local (apenas)</button>
        <a href="dashboard.html" class="btn small ghost">Voltar</a>
      </div>
      <div id="msg" class="msg"></div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGeQ1-IKrCyC8hA2BETaJLidLpuYrCRmk",
  authDomain: "alphajournal-dc6bb.firebaseapp.com",
  projectId: "alphajournal-dc6bb",
  storageBucket: "alphajournal-dc6bb.appspot.com",
  messagingSenderId: "835722822229",
  appId: "1:835722822229:web:974ee6dc7b6696f1edcadc"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
onAuthStateChanged(auth, (u)=>{ if(!u) location.href='index.html'; currentUser = u; });

function readFileAsBytes(file){ return file.arrayBuffer(); }

async function uploadImage(file, id){
  const path = `prints/${currentUser.uid}/${id}_${file.name}`;
  const storageRef = ref(storage, path);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);
  return url;
}

document.getElementById('btnSave').addEventListener('click', async ()=>{
  const ativo = document.getElementById('ativo').value.trim();
  const tipo = document.getElementById('tipo').value;
  const data = document.getElementById('data').value || new Date().toISOString().slice(0,10);
  const resultado = parseFloat(document.getElementById('resultado').value||0);
  const quantidade = document.getElementById('quantidade').value;
  const setup = document.getElementById('setup').value.trim();
  const obs = document.getElementById('obs').value.trim();
  const file = document.getElementById('print').files[0];

  if(!ativo || !setup){ document.getElementById('msg').textContent = 'Preencha ao menos Ativo e Setup.'; return; }

  const id = 't_'+Date.now();
  document.getElementById('msg').textContent = 'Salvando...';

  let imageURL = null;
  if(file){
    try { imageURL = await uploadImage(file, id); } catch(e){ console.error(e); document.getElementById('msg').textContent = 'Erro no upload: '+e.message; return; }
  }

  // write to Firestore under collection trades
  try {
    await setDoc(doc(collection(db,'trades'), id), {
      id, userId: currentUser.uid, ativo, tipo, data, resultado, quantidade, setup, obs, imageURL: imageURL || null, createdAt: serverTimestamp(), synced: true
    });
    document.getElementById('msg').textContent = 'Trade salvo e sincronizado!';
    setTimeout(()=> location.href='dashboard.html', 900);
  } catch(err){
    console.error(err);
    document.getElementById('msg').textContent = 'Erro ao salvar trade: '+err.message;
  }
});

document.getElementById('btnSaveLocal').addEventListener('click', ()=>{
  const ativo = document.getElementById('ativo').value.trim();
  const setup = document.getElementById('setup').value.trim();
  if(!ativo || !setup){ document.getElementById('msg').textContent = 'Preencha ao menos Ativo e Setup.'; return; }
  const id = 'local_'+Date.now();
  const trade = {
    id, userId: 'local', ativo, tipo: document.getElementById('tipo').value, data: document.getElementById('data').value || new Date().toISOString().slice(0,10),
    resultado: parseFloat(document.getElementById('resultado').value||0), quantidade: document.getElementById('quantidade').value, setup: setup, obs: document.getElementById('obs').value, imageURL:null, synced:false, createdAt: new Date().toISOString()
  };
  const list = JSON.parse(localStorage.getItem('aj_trades')||'[]'); list.push(trade); localStorage.setItem('aj_trades', JSON.stringify(list));
  document.getElementById('msg').textContent = 'Trade salvo localmente.';
});
</script>
</body>
</html>
