<!doctype html>
<html lang="pt-BR">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Registrar Trade</title><link rel="stylesheet" href="style.css"></head>
<body>
  <div class="auth-wrap">
    <div class="auth-card" style="max-width:900px;">
      <h2>Registrar Trade</h2>

      <form id="tradeForm">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><label>Ativo</label><input id="ativo" required></div>
          <div><label>Data</label><input id="data" type="date" required></div>
          <div><label>Operação</label><select id="tipo"><option value="Compra">Compra</option><option value="Venda">Venda</option></select></div>
          <div><label>Resultado</label><select id="resultado"><option value="win">Win</option><option value="loss">Loss</option><option value="be">Breakeven</option></select></div>
          <div><label>Resultado Financeiro (R$)</label><input id="financeiro" type="number" step="0.01" required></div>
          <div><label>Quantidade</label><input id="quantidade" type="number"></div>
          <div style="grid-column:1 / -1"><label>Setup</label><input id="setup"></div>
          <div style="grid-column:1 / -1"><label>Observações</label><textarea id="obs" rows="4"></textarea></div>
          <div style="grid-column:1 / -1"><label>Print da Operação</label><input id="print" type="file" accept="image/*"></div>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="btnSave" class="btn primary" type="submit">Salvar e Sincronizar</button>
          <button id="btnSaveLocal" type="button" class="btn ghost">Salvar Local (apenas)</button>
          <a href="dashboard.html" class="btn ghost">Voltar</a>
        </div>
      </form>

      <div id="msg" class="msg"></div>
    </div>
  </div>

  <!-- firebase init -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="firebase.js"></script>

  <script>
    const auth = window.auth;
    const db = window.db;
    const storage = window.storage;

    const tradeForm = document.getElementById('tradeForm');
    const btnSave = document.getElementById('btnSave');
    const msg = document.getElementById('msg');

    function showMsg(txt, ok=true){ msg.textContent = txt; msg.style.color = ok ? '#66ff99' : '#ff8888'; }

    tradeForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!auth.currentUser){ showMsg('Por favor faça login.', false); return; }
      btnSave.disabled = true; showMsg('Salvando...');

      const ativo = document.getElementById('ativo').value.trim();
      const data = document.getElementById('data').value; // YYYY-MM-DD
      const tipo = document.getElementById('tipo').value;
      const resultado = document.getElementById('resultado').value;
      const financeiro = parseFloat(document.getElementById('financeiro').value||0);
      const quantidade = Number(document.getElementById('quantidade').value||0);
      const setup = document.getElementById('setup').value.trim();
      const obs = document.getElementById('obs').value.trim();
      const file = document.getElementById('print').files[0];

      try{
        const userId = auth.currentUser.uid;
        const tradeRef = db.collection('users').doc(userId).collection('trades').doc();
        const tradeId = tradeRef.id;

        let imageURL = null;
        if(file){
          const storageRef = storage.ref().child(`prints/${userId}/${tradeId}_${file.name}`);
          await storageRef.put(file);
          imageURL = await storageRef.getDownloadURL();
        }

        await tradeRef.set({
          id: tradeId, userId, ativo, data, tipo, resultado, financeiro, quantidade,
          setup: setup || null, obs: obs || null, imageURL: imageURL || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showMsg('✅ Trade salva e sincronizada!');
        tradeForm.reset();
        setTimeout(()=> window.location.href = 'dashboard.html', 700);

      }catch(err){
        console.error(err);
        showMsg('Erro ao salvar: '+(err.message||err), false);
        btnSave.disabled = false;
      }
    });

    document.getElementById('btnSaveLocal').addEventListener('click', ()=>{
      const trade = { id:'local_'+Date.now(), userId:'local', ativo:document.getElementById('ativo').value, data:document.getElementById('data').value, tipo:document.getElementById('tipo').value, resultado:document.getElementById('resultado').value, financeiro:parseFloat(document.getElementById('financeiro').value||0) };
      const list = JSON.parse(localStorage.getItem('aj_trades')||'[]'); list.push(trade); localStorage.setItem('aj_trades', JSON.stringify(list));
      showMsg('Trade salva localmente.');
    });
  </script>
</body>
</html>
